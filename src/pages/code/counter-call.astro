---
import Head from "@components/Head.astro";
---

<html lang="zh-Hant">
    <head>
        <Head path="code/counter-call" title="叫號系統 | 毛哥EM的基地" description="簡易叫號系統" theme="#FFF" />
        <style is:global>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            body {
                font-family:
                    system-ui,
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Roboto,
                    Oxygen,
                    Ubuntu,
                    Cantarell,
                    "Open Sans",
                    "Helvetica Neue",
                    sans-serif;
                background-color: #f8f9fa;
                padding: 3rem;
                color: #333;
            }

            button,
            input {
                font-family: inherit;
            }

            h1 {
                color: #0d6efd;
                font-size: 3rem;
                margin-bottom: 2rem;
            }
            .settings {
                margin-bottom: 2rem;
            }
            .settings input {
                padding: 0.5rem;
                font-size: 0.875rem;
                border: 1px solid #ccc;
                border-radius: 6px;
            }
            .settings button {
                margin-left: 10px;
                padding: 6px 12px;
                background-color: #198754;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
            }
            .settings button:hover {
                background-color: #157347;
            }
            .counter-card {
                background-color: white;
                border: 1px solid #dee2e6;
                border-radius: 1rem;
                padding: 2.5rem;
                flex: 1;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
                min-width: 14rem;
            }
            .counter-title {
                font-weight: bold;
                font-size: 1.5rem;
            }
            .counter-status {
                font-size: 2rem;
                color: #555;
            }
            .counter-status.busy {
                color: #dc3545;
            }
            .counter-status.free {
                color: #198754;
            }
            .counter-card button {
                margin-top: 1rem;
                padding: 0.5rem 1rem;
                background-color: #ffc107;
                color: #212529;
                border: none;
                border-radius: 0.5rem;
                cursor: pointer;
                font-size: 1.5rem;
            }
            .counter-card button:hover {
                background-color: #e0a800;
            }
            #callButton {
                margin-top: 2rem;
                padding: 1rem 2rem;
                font-size: 1.5rem;
                background-color: #0d6efd;
                color: white;
                border: none;
                border-radius: 0.5rem;
                cursor: pointer;
            }
            #callButton:hover {
                background-color: #0b5ed7;
            }

            #counters {
                display: flex;
                gap: 2rem;
                flex-wrap: wrap;
            }
        </style>
    </head>
    <body>
        <h1>即時叫號</h1>

        <div class="settings">
            <label>
                開始號碼：
                <input type="number" id="startNumberInput" value="1" min="1" />
            </label>
            <label style="margin-left: 20px;">
                櫃檯數：
                <input type="number" id="counterCountInput" value="3" min="1" />
            </label>
            <!-- <button onclick="">設定</button> -->
        </div>

        <div id="counters"></div>

        <button id="callButton" onclick="callNext()">叫號</button>

        <script is:inline>
            let currentNumber = 1;
            let counters = [];
            let startNumber = 1;

            // 新增：用來記錄每個櫃檯上次變成空閒的時間
            let freeSince = [];

            function applySettings() {
                const newStart = parseInt(document.getElementById("startNumberInput").value);
                const newCount = parseInt(document.getElementById("counterCountInput").value);

                if (newStart > currentNumber) {
                    currentNumber = newStart;
                }
                // fill freeSince with current time
                const newCounters = Array(newCount).fill(null);
                const newFreeSince = Array(newCount).fill(new Date().getTime());

                for (let i = 0; i < Math.min(counters.length, newCount); i++) {
                    newCounters[i] = counters[i];
                    newFreeSince[i] = freeSince[i];
                }

                counters = newCounters;
                freeSince = newFreeSince;

                renderCounters();
            }

            function markFree(index) {
                counters[index] = null;
                freeSince[index] = Date.now(); // 記錄空閒時間
                renderCounters();
            }

            function callNext() {
                let bestIndex = -1;
                let oldestTime = Infinity;

                for (let i = 0; i < counters.length; i++) {
                    if (counters[i] === null && freeSince[i] !== null && freeSince[i] < oldestTime) {
                        bestIndex = i;
                        oldestTime = freeSince[i];
                    }
                }

                if (bestIndex === -1) {
                    alert("所有櫃檯都在忙碌中！");
                    return;
                }
                const msg = new SpeechSynthesisUtterance(`請 ${currentNumber} 號，到櫃檯 ${bestIndex + 1}`);
                msg.lang = "zh-TW"; // 設定語言為中文（台灣）
                speechSynthesis.speak(msg);

                counters[bestIndex] = currentNumber++;
                freeSince[bestIndex] = null; // 現在這櫃檯正在服務中
                renderCounters();
            }

            // onchange auto apply settings
            document.getElementById("startNumberInput").addEventListener("change", applySettings);
            document.getElementById("counterCountInput").addEventListener("change", applySettings);

            function renderCounters() {
                const container = document.getElementById("counters");
                container.innerHTML = "";
                counters.forEach((val, idx) => {
                    const div = document.createElement("div");
                    div.className = "counter-card";

                    const status = val === null ? `<span class="counter-status free">空閒中</span>` : `<span class="counter-status busy">號碼：${val}</span>`;

                    div.innerHTML = `
        <div>
          <div class="counter-title">櫃檯 ${idx + 1}</div>
          ${status}
        </div>
        <button onclick="markFree(${idx})">沒人</button>
      `;
                    container.appendChild(div);
                });
            }

            window.onload = () => {
                applySettings();
                // 初始化櫃檯狀態
                const start = parseInt(document.getElementById("startNumberInput").value);
                const count = parseInt(document.getElementById("counterCountInput").value);
            };
        </script>
    </body>
</html>
